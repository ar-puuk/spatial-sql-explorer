<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spatial SQL Explorer</title>

    <!-- Cross-Origin Isolation for SharedArrayBuffer (DuckDB-WASM multithreading) -->
    <!-- Download from: https://unpkg.com/coi-serviceworker@0.1.7/coi-serviceworker.min.js -->
    <script src="coi-serviceworker.min.js"></script>

    <!-- MapLibre GL JS v5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maplibre-gl@5/dist/maplibre-gl.css" />
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@5/dist/maplibre-gl.js"></script>

    <!-- MapLibre Geocoder -->
    <link rel="stylesheet"
        href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.css" />
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.min.js"></script>

    <!-- App styles -->
    <link rel="stylesheet" href="css/style.css" />

    <!--
      !! EXACTLY ONE import map per page !!
      Browsers silently discard ALL entries from any second importmap block.
      NEVER add another <script type="importmap"> to this file.
      To add a package: add one entry to the imports object below.

      The * prefix tells esm.sh NOT to bundle deps. It emits bare specifiers
      which the browser resolves through this map, guaranteeing one shared
      module instance per package (no duplicate @codemirror/state, etc.).
    -->
    <script type="importmap">
    {
      "imports": {
        "codemirror":                    "https://esm.sh/*codemirror@6.0.1",
        "@codemirror/view":              "https://esm.sh/*@codemirror/view@6.36.3",
        "@codemirror/state":             "https://esm.sh/*@codemirror/state@6.4.1",
        "@codemirror/language":          "https://esm.sh/*@codemirror/language@6.10.8",
        "@codemirror/commands":          "https://esm.sh/*@codemirror/commands@6.7.1",
        "@codemirror/search":            "https://esm.sh/*@codemirror/search@6.5.8",
        "@codemirror/autocomplete":      "https://esm.sh/*@codemirror/autocomplete@6.18.6",
        "@codemirror/lint":              "https://esm.sh/*@codemirror/lint@6.8.4",
        "@codemirror/lang-sql":          "https://esm.sh/*@codemirror/lang-sql@6.8.0",
        "@codemirror/theme-one-dark":    "https://esm.sh/*@codemirror/theme-one-dark@6.1.2",
        "@codemirror/":                  "https://esm.sh/*@codemirror/",
        "@lezer/common":                 "https://esm.sh/*@lezer/common@1.2.3",
        "@lezer/highlight":              "https://esm.sh/*@lezer/highlight@1.2.1",
        "@lezer/lr":                     "https://esm.sh/*@lezer/lr@1.4.2",
        "@lezer/":                       "https://esm.sh/*@lezer/",
        "style-mod":                     "https://esm.sh/style-mod@4.1.2",
        "w3c-keyname":                   "https://esm.sh/w3c-keyname@2.2.8",
        "crelt":                         "https://esm.sh/crelt@1.0.6",
        "@marijn/find-cluster-break":    "https://esm.sh/@marijn/find-cluster-break@1.0.2"
      }
    }
    </script>
</head>

<body>

    <!-- ═══════════════════════════════════════════════════════════
     INIT OVERLAY
     ═══════════════════════════════════════════════════════════ -->
    <div id="init-overlay">
        <div class="init-spinner"></div>
        <div class="init-title">⬡ Spatial SQL Explorer</div>
        <div class="init-log" id="init-log">Starting up…</div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════
     APP SHELL — three-column grid
     ═══════════════════════════════════════════════════════════ -->
    <div id="app">

        <!-- ── LEFT PANEL ─────────────────────────────────────────── -->
        <div id="panel-left">

            <!-- App header -->
            <div id="app-header">
                <div id="app-header-top">
                    <a id="app-title" href="./" title="Reset to home">⬡ Spatial SQL Explorer</a>
                    <button id="theme-toggle" title="Toggle light / dark mode" aria-label="Toggle theme">☾</button>
                </div>
                <div id="app-subtitle">DuckDB-WASM · MapLibre GL · 100% client-side</div>
            </div>

            <!-- ── Table Registry ────────────────────────────────────── -->
            <div class="left-section" id="section-registry">
                <div class="section-header">
                    <span class="section-label">Loaded Tables</span>
                    <button class="icon-btn danger" id="clear-session-btn" title="Clear saved session data">⟳ clear
                        session</button>
                </div>
                <div id="table-registry">
                    <div class="registry-empty">No tables loaded.</div>
                </div>
            </div>

            <!-- ── Data Source ────────────────────────────────────────── -->
            <div class="left-section" id="section-datasource">
                <div class="section-label">Load Data</div>

                <div class="btn-row">
                    <button class="btn" id="btn-demo">Demo Data</button>
                </div>

                <!-- Hidden file input — accepts all supported formats -->
                <input type="file" id="file-input" accept=".geojson,.json,.csv,.tsv,.parquet" multiple />

                <div id="drop-zone">
                    <span class="drop-icon">⬆</span>
                    <span class="drop-main">Drop files here or click to browse</span>
                    <span class="drop-formats">GeoJSON · CSV · TSV · Parquet</span>
                </div>
            </div>

            <!-- ── SQL Editor ──────────────────────────────────────────── -->
            <div id="editor-section">
                <div id="editor-label">
                    <span class="section-label" style="margin-bottom:0">SQL Query</span>
                    <span id="editor-hint">Ctrl+Enter to run</span>
                </div>
                <div id="editor-wrapper"></div>
            </div>

            <!-- ── Run Controls ─────────────────────────────────────────── -->
            <div id="run-controls">
                <button class="btn btn-primary" id="run-btn">▶ Run Query</button>
                <span class="cap-label">LIMIT</span>
                <input type="number" id="safety-cap-input" value="50000" min="1" max="500000"
                    title="Auto-appended LIMIT if your query has none" />
            </div>

            <!-- ── Query History ─────────────────────────────────────────── -->
            <div id="query-history">
                <div class="section-label">Query History</div>
            </div>

        </div><!-- end panel-left -->


        <!-- ── RESIZE HANDLE: left ───────────────────────────────── -->
        <div class="resize-handle" id="resize-left" title="Drag to resize"></div>

        <!-- ── CENTER PANEL: Map ──────────────────────────────────── -->
        <div id="panel-map">
            <div id="map"></div>

            <!-- Basemap switcher overlay (top-left) -->
            <div id="basemap-switcher">
                <button class="basemap-pill active" data-basemap="light">Light</button>
                <button class="basemap-pill" data-basemap="dark">Dark</button>
                <button class="basemap-pill" data-basemap="satellite">Satellite</button>
                <button class="basemap-pill" data-basemap="topo">Topo</button>
            </div>

            <!-- Interactive map legend (bottom-left, shown after Apply) -->
            <div id="map-legend" style="display:none">
                <div id="map-legend-inner"></div>
            </div>

            <div id="map-statusbar">
                <span id="map-coords">–</span>
                <span id="map-engine">DuckDB-WASM · spatial ext · MapLibre GL v5</span>
                <button id="export-png-btn" title="Export map as PNG">⬇ PNG</button>
            </div>
        </div>


        <!-- ── RESIZE HANDLE: right ──────────────────────────────── -->
        <div class="resize-handle" id="resize-right" title="Drag to resize"></div>

        <!-- ── RIGHT PANEL: Output + Style ───────────────────────── -->
        <div id="panel-right">

            <!-- Output header + export buttons -->
            <div id="output-header">
                <div id="output-header-top">
                    <div>
                        <div id="output-title">Query Output</div>
                        <div id="output-meta">Run a query to see results.</div>
                    </div>
                    <div id="export-btns">
                        <button class="btn btn-export" id="share-url-btn"
                            title="Copy shareable link with current query &amp; style">⬡ Share</button>
                        <button class="btn btn-export" id="export-csv-btn"
                            title="Download filtered result as CSV">CSV</button>
                        <button class="btn btn-export" id="export-geojson-btn"
                            title="Download filtered result as GeoJSON">GeoJSON</button>
                    </div>
                </div>
            </div>

            <!-- Error banner -->
            <div id="error-banner"></div>

            <!-- Loading indicator -->
            <div id="query-loading">
                <div class="mini-spinner"></div>
                Executing query…
            </div>

            <!-- ── Style Panel ───────────────────────────────────────── -->
            <div id="style-panel" style="display:none">

                <div class="style-panel-header">
                    <span class="section-label" style="margin-bottom:0">Map Style</span>
                    <button class="btn btn-sm" id="apply-style-btn">Apply</button>
                </div>

                <!-- Mode pill toggle -->
                <div class="style-row">
                    <div class="mode-pills" id="style-mode-pills">
                        <button class="mode-pill active" data-mode="single">Single</button>
                        <button class="mode-pill" data-mode="graduated">Graduated</button>
                        <button class="mode-pill" data-mode="categorical">Categorical</button>
                    </div>
                </div>

                <!-- Column selector (hidden in single mode) -->
                <div class="style-row" id="style-row-col" style="display:none">
                    <label class="style-label">Column</label>
                    <select id="style-col-select" class="style-select"></select>
                </div>

                <!-- Single color picker -->
                <div class="style-row" id="style-row-single">
                    <label class="style-label">Color</label>
                    <div class="single-color-row">
                        <input type="color" id="style-single-color" value="#f0a500" class="color-picker" />
                        <span id="style-single-hex" class="hex-label">#f0a500</span>
                    </div>
                </div>

                <!-- Graduated controls -->
                <div id="style-graduated-controls" style="display:none">
                    <div class="style-row">
                        <label class="style-label">Method</label>
                        <div class="classify-pills" id="classify-method-pills">
                            <button class="classify-pill active" data-method="quantile">Quantile</button>
                            <button class="classify-pill" data-method="equal">Equal Interval</button>
                            <button class="classify-pill" data-method="jenks">Natural Breaks</button>
                        </div>
                    </div>

                    <div class="style-row">
                        <label class="style-label">Classes</label>
                        <div class="class-count-btns" id="class-count-btns">
                            <button class="class-count-btn" data-n="3">3</button>
                            <button class="class-count-btn active" data-n="5">5</button>
                            <button class="class-count-btn" data-n="7">7</button>
                            <button class="class-count-btn" data-n="9">9</button>
                        </div>
                    </div>

                    <div class="style-row">
                        <label class="style-label">Ramp</label>
                        <div id="ramp-swatches"></div>
                        <button class="icon-btn" id="invert-ramp-btn" title="Invert ramp">⇅</button>
                    </div>
                </div>

                <!-- Opacity slider (always visible) -->
                <div class="style-row">
                    <label class="style-label">Opacity</label>
                    <div class="opacity-row">
                        <input type="range" id="style-opacity" min="0" max="100" value="85" class="opacity-slider" />
                        <span id="style-opacity-val" class="opacity-val">85%</span>
                    </div>
                </div>

                <!-- Legend -->
                <div id="style-legend"></div>

            </div>

            <!-- Empty state -->
            <div id="empty-state">
                <div class="empty-icon">⬡</div>
                <p>Write a SQL query and press<br><strong>Run Query</strong> to see results here.</p>
            </div>

            <!-- Results table injected here -->
            <div id="table-wrapper"></div>

        </div><!-- end panel-right -->

    </div><!-- end #app -->

    <script type="module" src="js/app.js"></script>
</body>

</html>
